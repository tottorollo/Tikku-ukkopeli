<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<title>Tikku-ukkopeli</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
html, body {
  margin: 0;
  padding: 0;
  background: black;
  overflow: hidden;
  touch-action: none;
  user-select: none;
  font-family: sans-serif;
}

#ui {
  position: absolute;
  top: 10px;
  width: 100%;
  display: flex;
  justify-content: center;
  z-index: 5;
}

#modeBtn {
  padding: 10px 20px;
  font-size: 16px;
  border-radius: 20px;
  border: 1px solid white;
  background: rgba(255,255,255,0.2);
  color: white;
}

canvas {
  background: #222;
  display: block;
  width: 100vw;
  height: 100vh;
  object-fit: contain;
}

.controls {
  position: absolute;
  bottom: 20px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  z-index: 10;
}

.left { left: 15px; }
.right { right: 15px; }

.row {
  display: flex;
  gap: 10px;
  justify-content: center;
}

.btn {
  width: 55px;
  height: 55px;
  border-radius: 12px;
  border: 2px solid rgba(255,255,255,0.5);
  background: rgba(85, 85, 85, 0.7);
  color: white;
  font-size: 12px;
  font-weight: bold;
  touch-action: manipulation;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
}

.btn:active {
  background: #888;
}
</style>
</head>

<body>

<div id="ui">
  <button id="modeBtn">Yksinpeli</button>
</div>

<div id="winText"
     style="
       position:absolute;
       top:45%;
       width:100%;
       text-align:center;
       font-size:36px;
       color:white;
       display:none;
       z-index:20;">
</div>

<canvas id="game" width="1280" height="720"></canvas>

<div class="controls left">
  <div class="row">
    <button class="btn" id="p1Left">‚Üê</button>
    <button class="btn" id="p1Punch">ISKU</button>
    <button class="btn" id="p1Jump">HYPPY</button>
  </div>
  <div class="row">
    <button class="btn" id="p1Right">‚Üí</button>
    <button class="btn" id="p1Kick">POTKU</button>
    <button class="btn" id="p1BlockHigh">TORJ ‚Üë</button>
  </div>
</div>

<div class="controls right" id="p2Controls" style="display:none">
  <div class="row">
    <button class="btn" id="p2Left">‚Üê</button>
    <button class="btn" id="p2Punch">ISKU</button>
    <button class="btn" id="p2Jump">HYPPY</button>
  </div>
  <div class="row">
    <button class="btn" id="p2Right">‚Üí</button>
    <button class="btn" id="p2Kick">POTKU</button>
    <button class="btn" id="p2BlockHigh">TORJ ‚Üë</button>
  </div>
</div>

<script>
// iOS zoom estot
let lastTouchEnd = 0;
document.addEventListener('touchend', e => {
  const now = Date.now();
  if (now - lastTouchEnd <= 300) e.preventDefault();
  lastTouchEnd = now;
}, { passive: false });

let winTimer = 0;
  
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
// Isku-osumaefektit
const hitEffects = [];

let multiplayer = false;
const GROUND_Y = canvas.height / 2 + 50; // Asetetaan hahmot keskelle korkeutta

document.getElementById("modeBtn").onclick = () => {
  multiplayer = !multiplayer;
  document.getElementById("modeBtn").innerText = multiplayer ? "Kaksinpeli" : "Yksinpeli";
  document.getElementById("p2Controls").style.display = multiplayer ? "flex" : "none";
};

function Player(x, color) {
  this.x = x;
  this.y = GROUND_Y;
  this.vy = 0;
  this.hp = 20;
  this.color = color;
  this.action = null;
  this.actionTime = 0;
  this.moving = 0; // -1: vasen, 1: oikea, 0: paikallaan
  this.jumpTime = 0;
  this.isJumping = false;
  this.baseY = this.y;
}

const p1 = new Player(400, "lime");
const p2 = new Player(880, "cyan");

function reset() {
  p1.x = 400; p2.x = 880;
  p1.hp = p2.hp = 20;
  p1.y = p2.y = GROUND_Y;
}

function hit(attacker, defender, range, type) {
  const d = Math.abs(attacker.x - defender.x);

    // Vastustaja ilmassa ‚Üí potku EI osu h√§neen
  if (defender.isJumping && attacker.action === "kick") return;

  // Hypp√§√§j√§ ‚Üí oma ly√∂nti EI osu
  if (attacker.isJumping && attacker.action === "punch") return;

  // Tulee osuma ja vahinkoa
  if (d < range && defender.action !== type) {
    defender.hp -= 0.1;

    // üî¥ Osuma-animaatio
    hitEffects.push({
      x: defender.x,
      y: defender.y - 60,
      time: 8
    });
  }
}

function ai() {
  if (multiplayer) return;
  const d = p2.x - p1.x;
  // AI liikkuu l√§hemm√§s
  if (Math.abs(d) > 120) p2.x += d > 0 ? -3 : 3;
  else {
    if (Math.random() < 0.05) p2.action = "punch";
    if (Math.random() < 0.03) p2.action = "kick";
    if (Math.random() < 0.02) p2.action = "blockHigh";
  }
}

function drawPlayer(p, enemy) {
  const dir = enemy.x > p.x ? 1 : -1;
  ctx.strokeStyle = p.color;
  ctx.lineWidth = 5;

  // P√§√§
  ctx.beginPath();
  ctx.arc(p.x, p.y - 80, 20, 0, Math.PI * 2);
  ctx.stroke();

  // Vartalo
  ctx.beginPath();
  ctx.moveTo(p.x, p.y - 60);
  ctx.lineTo(p.x, p.y);
  ctx.stroke();

  // Jalat
  ctx.beginPath();
  ctx.moveTo(p.x, p.y);
  ctx.lineTo(p.x - 20, p.y + 50);
  ctx.moveTo(p.x, p.y);
  ctx.lineTo(p.x + 20, p.y + 50);
  ctx.stroke();

  // K√§det / Toiminnot
  ctx.beginPath();
  if (p.action === "punch") {
    ctx.moveTo(p.x, p.y - 40);
    ctx.lineTo(p.x + dir * 80, p.y - 40);
  } else if (p.action === "kick") {
    ctx.moveTo(p.x, p.y);
    ctx.lineTo(p.x + dir * 90, p.y + 10);
  } else if (p.action === "blockHigh") {
    ctx.moveTo(p.x, p.y - 50);
    ctx.lineTo(p.x + dir * 30, p.y - 90);
    ctx.lineTo(p.x + dir * 50, p.y - 70);
  } else {
    // Perusasento (k√§det alhaalla)
    ctx.moveTo(p.x, p.y - 40);
    ctx.lineTo(p.x + dir * 30, p.y - 20);
  }
  ctx.stroke();
}

function drawHP(p, x) {
  ctx.fillStyle = "#333";
  ctx.fillRect(x, 40, 200, 20);
  ctx.fillStyle = p.color;
  ctx.fillRect(x, 40, (p.hp / 20) * 200, 20);
  ctx.strokeStyle = "white";
  ctx.strokeRect(x, 40, 200, 20);
}

function update() {
  ai();

  // Liikkuminen
  p1.x += p1.moving * 5;
  if (multiplayer) p2.x += p2.moving * 5;

  // Rajat
  p1.x = Math.max(50, Math.min(canvas.width - 50, p1.x));
  p2.x = Math.max(50, Math.min(canvas.width - 50, p2.x));

  updateJump(p1);
  updateJump(p2);
  
  // Hy√∂kk√§ykset
  if (p1.action === "punch") hit(p1, p2, 120, "blockHigh");
  if (p1.action === "kick") hit(p1, p2, 140, "none"); 
  if (p2.action === "punch") hit(p2, p1, 120, "blockHigh");
  if (p2.action === "kick") hit(p2, p1, 140, "none"); 

  // Animaatioiden kesto
  if (p1.action) {
    p1.actionTime++;
    if (p1.actionTime > 15) { p1.action = null; p1.actionTime = 0; }
  }
  if (p2.action) {
    p2.actionTime++;
    if (p2.actionTime > 15) { p2.action = null; p2.actionTime = 0; }
  }

  if (p1.hp <= 0 || p2.hp <= 0) {
  const winText = document.getElementById("winText");

  winText.innerText =
    p1.hp <= 0 ? "Pelaaja 2 voittaa!" : "Pelaaja 1 voittaa!";

  winText.style.display = "block";
  winTimer++;

  // N√§yt√§ ilmoitus ~2 sekuntia
  if (winTimer > 120) {
    winText.style.display = "none";
    winTimer = 0;
    reset();
  }

  return; // est√§√§ lis√§p√§ivitykset er√§n lopussa
}
}

function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  
  // Piirr√§ "lattia" keskelle
  ctx.strokeStyle = "#444";
  ctx.beginPath();
  ctx.moveTo(0, GROUND_Y + 50);
  ctx.lineTo(canvas.width, GROUND_Y + 50);
  ctx.stroke();

  //  Piirr√§ osuma-animaatiot
  for (let i = hitEffects.length - 1; i >= 0; i--) {
  const h = hitEffects[i];
  ctx.fillStyle = "rgba(255,0,0,0.6)";
  ctx.beginPath();
  ctx.arc(h.x, h.y, 18, 0, Math.PI * 2);
  ctx.fill();

  h.time--;
  if (h.time <= 0) hitEffects.splice(i, 1);
  }

  drawHP(p1, 50);
  drawHP(p2, canvas.width - 250);
  drawPlayer(p1, p2);
  drawPlayer(p2, p1);
}

function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();

  // HYPPYLOGIIKKA
  function updateJump(p) {
  if (!p.isJumping) return;

  p.jumpTime++;

  const jumpDuration = 60; // 1s @ 60fps
  const jumpHeight = 60;   // ~0.5 ukon korkeudesta

  const t = p.jumpTime / jumpDuration;
  


  // Yl√∂s ja alas (siniaalto)
  p.y = p.baseY - Math.sin(Math.PI * t) * jumpHeight;

  if (p.jumpTime >= jumpDuration) {
    p.isJumping = false;
    p.jumpTime = 0;
    p.y = p.baseY;
  }
  }

// Nappien sidonta (Touch + Mouse)
function bind(id, startFn, endFn) {
  const btn = document.getElementById(id);
  
  const start = (e) => {
    e.preventDefault();
    startFn();
  };
  const end = (e) => {
    e.preventDefault();
    if(endFn) endFn();
  };

  btn.addEventListener('touchstart', start, {passive: false});
  btn.addEventListener('touchend', end, {passive: false});
  btn.addEventListener('mousedown', start);
  btn.addEventListener('mouseup', end);
}

// Pelaaja 1 ohjaimet
bind("p1Left", () => p1.moving = -1, () => p1.moving = 0);
bind("p1Right", () => p1.moving = 1, () => p1.moving = 0);
bind("p1Punch", () => { if(!p1.action) p1.action = "punch" });
bind("p1Kick", () => { if(!p1.action) p1.action = "kick" });
bind("p1BlockHigh", () => p1.action = "blockHigh", () => p1.action = null);
bind("p1Jump", () => {
  if (!p1.isJumping) {
    p1.isJumping = true;
    p1.jumpTime = 0;
    p1.baseY = GROUND_Y;
  }
});

// Pelaaja 2 ohjaimet
bind("p2Left", () => p2.moving = -1, () => p2.moving = 0);
bind("p2Right", () => p2.moving = 1, () => p2.moving = 0);
bind("p2Punch", () => { if(!p2.action) p2.action = "punch" });
bind("p2Kick", () => { if(!p2.action) p2.action = "kick" });
bind("p2BlockHigh", () => p2.action = "blockHigh", () => p2.action = null);
bind("p2Jump", () => {
  if (!p2.isJumping) {
    p2.isJumping = true;
    p2.jumpTime = 0;
    p2.baseY = GROUND_Y;
  }
});

</script>
</body>
</html>
