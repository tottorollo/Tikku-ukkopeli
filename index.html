<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<title>Tikku-ukkopeli</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
html, body {
  margin: 0;
  padding: 0;
  background: black;
  overflow: hidden;
  touch-action: none;
  user-select: none;
  font-family: sans-serif;
}

#ui {
  position: absolute;
  top: 10px;
  width: 100%;
  display: flex;
  justify-content: center;
  z-index: 5;
}

#modeBtn {
  padding: 10px 20px;
  font-size: 16px;
  border-radius: 20px;
  border: 1px solid white;
  background: rgba(255,255,255,0.2);
  color: white;
}

#winText {
  position: absolute;
  top: 45%;
  width: 100%;
  text-align: center;
  font-size: 36px;
  color: white;
  display: none;
  z-index: 20;
}

canvas {
  background: #222;
  display: block;
  width: 100vw;
  height: 100vh;
  object-fit: contain;
}

.controls {
  position: absolute;
  bottom: 20px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  z-index: 10;
}

.left { left: 15px; }
.right { right: 15px; }

.row {
  display: flex;
  gap: 10px;
  justify-content: center;
}

.btn {
  width: 55px;
  height: 55px;
  border-radius: 12px;
  border: 2px solid rgba(255,255,255,0.5);
  background: rgba(85, 85, 85, 0.7);
  color: white;
  font-size: 12px;
  font-weight: bold;
  touch-action: manipulation;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
}

.btn:active {
  background: #888;
}
</style>
</head>

<body>

<div id="ui">
  <button id="modeBtn">Yksinpeli</button>
</div>

<div id="winText"></div>

<canvas id="game" width="1280" height="720"></canvas>

<div class="controls left">
  <div class="row">
    <button class="btn" id="p1Left">←</button>
    <button class="btn" id="p1Right">→</button>
    <button class="btn" id="p1Jump">HYPPY</button>
  </div>
  <div class="row">
    <button class="btn" id="p1Punch">ISKU</button>
    <button class="btn" id="p1Kick">POTKU</button>
    <button class="btn" id="p1BlockHigh">TORJ ↑</button>
  </div>
</div>

<div class="controls right" id="p2Controls" style="display:none">
  <div class="row">
    <button class="btn" id="p2Left">←</button>
    <button class="btn" id="p2Right">→</button>
    <button class="btn" id="p2Jump">HYPPY</button>
  </div>
  <div class="row">
    <button class="btn" id="p2Punch">ISKU</button>
    <button class="btn" id="p2Kick">POTKU</button>
    <button class="btn" id="p2BlockHigh">TORJ ↑</button>
  </div>
</div>

<script>
// iOS zoom estot
let lastTouchEnd = 0;
document.addEventListener('touchend', e => {
  const now = Date.now();
  if (now - lastTouchEnd <= 300) e.preventDefault();
  lastTouchEnd = now;
}, { passive: false });

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

let multiplayer = false;
const GROUND_Y = canvas.height / 2 + 50;

document.getElementById("modeBtn").onclick = () => {
  multiplayer = !multiplayer;
  document.getElementById("modeBtn").innerText = multiplayer ? "Kaksinpeli" : "Yksinpeli";
  document.getElementById("p2Controls").style.display = multiplayer ? "flex" : "none";
};

function Player(x, color) {
  this.x = x;
  this.y = GROUND_Y;
  this.vy = 0;
  this.onGround = true;
  this.hp = 20;
  this.color = color;
  this.action = null;
  this.actionTime = 0;
  this.moving = 0;
}

const p1 = new Player(400, "lime");
const p2 = new Player(880, "cyan");

let hitEffects = [];
let winTimer = 0;

function reset() {
  p1.x = 400; p2.x = 880;
  p1.hp = p2.hp = 20;
  p1.y = p2.y = GROUND_Y;
  p1.vy = p2.vy = 0;
  p1.onGround = p2.onGround = true;
  document.getElementById("winText").style.display = "none";
  winTimer = 0;
}

function hit(attacker, defender, range, type) {
  const d = Math.abs(attacker.x - defender.x);
  if (d < range && defender.action !== type) {
    defender.hp -= 0.1;
    hitEffects.push({ x: defender.x, y: defender.y - 60, t: 8 });
  }
}

function ai() {
  if (multiplayer) return;
  const d = p2.x - p1.x;
  if (Math.abs(d) > 150) p2.x += d > 0 ? -3 : 3;
  else if (Math.random() < 0.05) p2.action = "punch";
}

function update() {
  ai();

  [p1, p2].forEach(p => {
    p.x += p.moving * 5;
    p.x = Math.max(50, Math.min(canvas.width - 50, p.x));

    if (!p.onGround) {
      p.vy += 1;
      p.y += p.vy;
      if (p.y >= GROUND_Y) {
        p.y = GROUND_Y;
        p.vy = 0;
        p.onGround = true;
      }
    }

    if (p.action) {
      p.actionTime++;
      if (p.actionTime > 15) {
        p.action = null;
        p.actionTime = 0;
      }
    }
  });

  if (p1.action === "punch") hit(p1, p2, 120, "blockHigh");
  if (p1.action === "kick") hit(p1, p2, 140, "none");
  if (p2.action === "punch") hit(p2, p1, 120, "blockHigh");

  if (p1.hp <= 0 || p2.hp <= 0) {
    const txt = document.getElementById("winText");
    txt.innerText = p1.hp <= 0 ? "Pelaaja 2 voittaa!" : "Pelaaja 1 voittaa!";
    txt.style.display = "block";
    winTimer++;
    if (winTimer > 120) reset();
  }
}

function drawPlayer(p, enemy) {
  const dir = enemy.x > p.x ? 1 : -1;
  ctx.strokeStyle = p.color;
  ctx.lineWidth = 5;

  ctx.beginPath();
  ctx.arc(p.x, p.y - 80, 20, 0, Math.PI * 2);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(p.x, p.y - 60);
  ctx.lineTo(p.x, p.y);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(p.x, p.y);
  ctx.lineTo(p.x - 20, p.y + 50);
  ctx.moveTo(p.x, p.y);
  ctx.lineTo(p.x + 20, p.y + 50);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(p.x, p.y - 40);
  ctx.lineTo(p.x + dir * (p.action === "punch" ? 80 : 30), p.y - 40);
  ctx.stroke();
}

function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  hitEffects.forEach(h => {
    ctx.fillStyle = "rgba(255,0,0,0.6)";
    ctx.beginPath();
    ctx.arc(h.x, h.y, 20, 0, Math.PI * 2);
    ctx.fill();
    h.t--;
  });
  hitEffects = hitEffects.filter(h => h.t > 0);

  drawPlayer(p1, p2);
  drawPlayer(p2, p1);
}

function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();

function bind(id, startFn, endFn) {
  const btn = document.getElementById(id);
  btn.addEventListener('touchstart', e => { e.preventDefault(); startFn(); }, {passive:false});
  btn.addEventListener('touchend', e => { e.preventDefault(); if(endFn) endFn(); }, {passive:false});
}

bind("p1Left", () => p1.moving = -1, () => p1.moving = 0);
bind("p1Right", () => p1.moving = 1, () => p1.moving = 0);
bind("p1Punch", () => { if(!p1.action) p1.action = "punch" });
bind("p1Kick", () => { if(!p1.action) p1.action = "kick" });
bind("p1BlockHigh", () => p1.action = "blockHigh", () => p1.action = null);
bind("p1Jump", () => {
  if (p1.onGround) {
    p1.vy = -18;
    p1.onGround = false;
  }
});
</script>
</body>
</html>
