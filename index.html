<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<title>Tikku-ukkopeli</title>

<meta name="viewport" content="
  width=device-width,
  initial-scale=1.0,
  maximum-scale=1.0,
  user-scalable=no
">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
html, body {
  margin: 0;
  padding: 0;
  background: black;
  overflow: hidden;
  touch-action: none;
  user-select: none;
}

#ui {
  position: absolute;
  top: 0;
  width: 100%;
  height: 80px;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 5;
}

#modeBtn {
  padding: 6px 10px;
  font-size: 18px;
  border-radius: 10px;
  border: none;
}

canvas {
  background: #222;
  display: block;
  margin: auto;
}

.controls {
  position: absolute;
  bottom: 20px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.left { left: 10px; }
.right { right: 10px; }

.row {
  display: flex;
  gap: 10px;
}

.btn {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: 2px solid white;
  background: #555;
  color: white;
  font-size: 14px;
  touch-action: manipulation;
}
</style>
</head>

<body>

<div id="ui">
  <button id="modeBtn">Yksinpeli</button>
</div>

<canvas id="game" width="1280" height="600"></canvas>

<div class="controls left">
  <div class="row">
    <button class="btn" id="p1Left">←</button>
    <button class="btn" id="p1Right">→</button>
  </div>
  <button class="btn" id="p1Jump">Hyppy</button>
  <button class="btn" id="p1Punch">Isku</button>
  <button class="btn" id="p1Kick">Potku</button>
  <button class="btn" id="p1BlockHigh">Torj ↑</button>
  <button class="btn" id="p1BlockLow">Torj ↓</button>
</div>

<div class="controls right" id="p2Controls" style="display:none">
  <div class="row">
    <button class="btn" id="p2Left">←</button>
    <button class="btn" id="p2Right">→</button>
  </div>
  <button class="btn" id="p2Jump">Hyppy</button>
  <button class="btn" id="p2Punch">Isku</button>
  <button class="btn" id="p2Kick">Potku</button>
  <button class="btn" id="p2BlockHigh">Torj ↑</button>
  <button class="btn" id="p2BlockLow">Torj ↓</button>
</div>

<script>
// iOS zoom estot
let lastTouchEnd = 0;
document.addEventListener('touchend', e => {
  const now = Date.now();
  if (now - lastTouchEnd <= 300) e.preventDefault();
  lastTouchEnd = now;
}, { passive: false });

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

let multiplayer = false;

document.getElementById("modeBtn").onclick = () => {
  multiplayer = !multiplayer;
  document.getElementById("modeBtn").innerText = multiplayer ? "Kaksinpeli" : "Yksinpeli";
  document.getElementById("p2Controls").style.display = multiplayer ? "flex" : "none";
};

function Player(x, color) {
  this.x = x;
  this.y = 420;
  this.vy = 0;
  this.hp = 20;
  this.color = color;
  this.action = null;
  this.actionTime = 0;
}

const p1 = new Player(500, "lime");
const p2 = new Player(780, "cyan");

function reset() {
  p1.x = 500; p2.x = 780;
  p1.hp = p2.hp = 20;
}

function hit(attacker, defender, range, type) {
  const d = Math.abs(attacker.x - defender.x);
  if (d < range && defender.action !== type) {
    defender.hp--;
  }
}

function ai() {
  if (multiplayer) return;
  const d = p2.x - p1.x;
  if (Math.abs(d) > 160) p2.x += d > 0 ? -2 : 2;
  else {
    if (Math.random() < 0.02) p2.action = "punch";
    if (Math.random() < 0.01) p2.action = "kick";
    if (Math.random() < 0.01) p2.action = "blockHigh";
    if (Math.random() < 0.01) p2.action = "blockLow";
  }
}

function drawPlayer(p, enemy) {
  const dir = enemy.x > p.x ? 1 : -1;
  ctx.strokeStyle = p.color;
  ctx.lineWidth = 4;

  ctx.beginPath();
  ctx.arc(p.x, p.y - 80, 20, 0, Math.PI * 2);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(p.x, p.y - 60);
  ctx.lineTo(p.x, p.y);
  ctx.stroke();

  // jalat
  ctx.beginPath();
  ctx.moveTo(p.x, p.y);
  ctx.lineTo(p.x - 20, p.y + 50);
  ctx.moveTo(p.x, p.y);
  ctx.lineTo(p.x + 20, p.y + 50);
  ctx.stroke();

  // käsi / potku animaatiot
  ctx.beginPath();
  if (p.action === "punch") {
    ctx.moveTo(p.x, p.y - 40);
    ctx.lineTo(p.x + dir * 80, p.y - 40);
  } else if (p.action === "kick") {
    ctx.moveTo(p.x, p.y);
    ctx.lineTo(p.x + dir * 90, p.y + 10);
  } else if (p.action === "blockHigh") {
    ctx.moveTo(p.x, p.y - 50);
    ctx.lineTo(p.x + dir * 40, p.y - 80);
  } else if (p.action === "blockLow") {
    ctx.moveTo(p.x, p.y - 30);
    ctx.lineTo(p.x + dir * 40, p.y);
  } else {
    ctx.moveTo(p.x, p.y - 40);
    ctx.lineTo(p.x + dir * 40, p.y - 40);
  }
  ctx.stroke();
}

function drawHP(p, x) {
  ctx.strokeStyle = "white";
  ctx.strokeRect(x, 20, 200, 12);
  ctx.fillStyle = "red";
  ctx.fillRect(x, 20, p.hp * 10, 12);
}

function update() {
  ai();

  if (p1.action === "punch") hit(p1, p2, 140, "blockHigh");
  if (p1.action === "kick") hit(p1, p2, 170, "blockLow");
  if (p2.action === "punch") hit(p2, p1, 140, "blockHigh");
  if (p2.action === "kick") hit(p2, p1, 170, "blockLow");

  p1.actionTime++; p2.actionTime++;
  if (p1.actionTime > 20) { p1.action = null; p1.actionTime = 0; }
  if (p2.actionTime > 20) { p2.action = null; p2.actionTime = 0; }

  if (p1.hp <= 0 || p2.hp <= 0) reset();
}

function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawHP(p1, 40);
  drawHP(p2, canvas.width - 240);
  drawPlayer(p1, p2);
  drawPlayer(p2, p1);
}

function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();

// napit
function bind(id, fn) {
  document.getElementById(id).ontouchstart = e => { e.preventDefault(); fn(); };
}

bind("p1Left", ()=>p1.x-=10);
bind("p1Right", ()=>p1.x+=10);
bind("p1Punch", ()=>p1.action="punch");
bind("p1Kick", ()=>p1.action="kick");
bind("p1BlockHigh", ()=>p1.action="blockHigh");
bind("p1BlockLow", ()=>p1.action="blockLow");

bind("p2Left", ()=>p2.x-=10);
bind("p2Right", ()=>p2.x+=10);
bind("p2Punch", ()=>p2.action="punch");
bind("p2Kick", ()=>p2.action="kick");
bind("p2BlockHigh", ()=>p2.action="blockHigh");
bind("p2BlockLow", ()=>p2.action="blockLow");
</script>
</body>
</html>

